{% extends "base.html" %}
{% block body %}
<h1>Forecasts for {{ product_name }}</h1>
<div class="forecast-wrapper">
  <div class="forecast-content">
    <div class="forecast-controls">
        <a href="{{ url_for('main.dashboard') }}">&larr; Back to Dashboard</a>
        {% if related_products %}
            <form action="{{ url_for('predict.forecast_product', product_code=request.view_args['product_code']) }}" method="get" class="comparison-form">
                <select name="compare_with">
                    <option value="">Compare with...</option>
                    {% for product in related_products %}
                        <option value="{{ product.code }}">{{ product.description }}</option>
                    {% endfor %}
                </select>
                <button type="submit">Compare</button>
            </form>
        {% endif %}
    </div>
    {% if comparison_name and comparison_prediction %}
      <h3>Side-by-Side Forecast Comparison</h3>
      <table style="width:100%;margin-top:1em;text-align:center;">
        <thead>
          <tr>
            <th>Week</th>
            <th>{{ product_name }}</th>
            <th>{{ comparison_name }}</th>
          </tr>
        </thead>
        <tbody>
          {% for p, c in zip(prediction, comparison_prediction) %}
            <tr>
              <td>{{ loop.index }}</td>
              <td>${{ p }}</td>
              <td>${{ c }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% elif prediction is defined and prediction is not none and prediction|length > 0 %}
      <h3>Predicted Prices for the Next {{ prediction|length }} Weeks:</h3>
      <ul>
        {% for p in prediction %}
          <li>Week {{ loop.index }}: ${{ p }}</li>
        {% endfor %}
      </ul>
        <div style="max-width:700px;margin:2em auto;">
          <canvas id="priceChart"></canvas>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <script>
          // Data passed from backend
          const historicalPrices = JSON.parse('{{ historical_prices|tojson|safe }}');
          const forecastedPrices = JSON.parse('{{ prediction|tojson|safe }}');
          const labels = [];
          for (let i = 0; i < historicalPrices.length; i++) {
            labels.push('Week ' + (i + 1));
          }
          for (let i = 0; i < forecastedPrices.length; i++) {
            labels.push('Forecast ' + (i + 1));
          }
          const data = {
            labels: labels,
            datasets: [
              {
                label: 'Historical Prices',
                data: historicalPrices,
                borderColor: 'rgba(52, 152, 219, 1)',
                backgroundColor: 'rgba(52, 152, 219, 0.2)',
                fill: false,
                tension: 0.2,
              },
              {
                label: 'Forecasted Prices',
                data: Array(historicalPrices.length).fill(null).concat(forecastedPrices),
                borderColor: 'rgba(39, 174, 96, 1)',
                backgroundColor: 'rgba(39, 174, 96, 0.2)',
                fill: false,
                borderDash: [5, 5],
                tension: 0.2,
              }
            ]
          };
          const config = {
            type: 'line',
            data: data,
            options: {
              responsive: true,
              plugins: {
                legend: {
                  position: 'top',
                },
                title: {
                  display: true,
                  text: 'Price Trend & Forecast'
                }
              },
              scales: {
                y: {
                  beginAtZero: false,
                  title: {
                    display: true,
                    text: 'Price ($)'
                  }
                },
                x: {
                  title: {
                    display: true,
                    text: 'Week'
                  }
                }
              }
            },
          };
          new Chart(document.getElementById('priceChart'), config);
        </script>
    {% elif error is defined and error %}
      <p style="color:#c0392b;">{{ error }}</p>
    {% else %}
      <p>No forecast data available for this product.</p>
    {% endif %}
  </div>
</div>
{% endblock %}
