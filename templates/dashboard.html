{% extends "base.html" %}
{% block body %}
 <h1>GenEcomm</h1>
<div class="dashboard-wrapper">
  <div class="sidebar" id="sidebar">
        <button class="close-sidebar-btn" onclick="toggleSidebar()">‚úñ</button>
    <div class="profile">
  <img src="{{ url_for('auth.user_image') }}" alt="Profile">
  <div class="profile-info">
    <h3>{{ current_user.username or current_user.email.split('@')[0] }}</h3>
    <span class="badge {{ current_user.subscription_tier or 'free' }}">{{ (current_user.subscription_tier or 'free')|upper }}</span>
    <a href = "{{url_for('auth.account_settings')}}">account settings</a>
  </div>
</div>

    <div class="usage-stats" style="padding: 0 1em; margin-bottom: 1em; color: #ccc; font-size: 0.9em;">
        <p>Forecasts: {{ current_user.forecast_count or 0 }} / 
            {% if current_user.subscription_tier == 'pro' %}10
            {% elif current_user.subscription_tier == 'premium' %}‚àû
            {% else %}5{% endif %}
        </p>
        {% if current_user.subscription_tier != 'premium' %}
            <a href="{{ url_for('subscription.pricing') }}" style="color: #4CAF50; text-decoration: none; font-weight: bold;">Upgrade Plan</a>
        {% endif %}
    </div>

    <a href="#">üè† Dashboard</a>
    <a href="#">üîç Search Product</a>
    <a href="#">üìà Forecasts</a>
  <a href="{{ url_for('recommendation.recommendation') }}">‚≠ê Recommendations</a>
    <a href="{{ url_for('auth.logout') }}" class="logout-btn">Log out</a>
  </div>

  <div class="main-content">
    <h2>Welcome, {{ current_user.username or current_user.email.split('@')[0] }}</h2>
    {% if prediction is defined and prediction is not none and prediction|length > 0 and product_name %}
      <p>Your last viewed product, {{ product_name }} - predicted price ${{ prediction[0] }} next week</p>
    {% endif %}
    <div class="all-products-section">
      <form action="{{ url_for('main.search_products') }}" method="get" style="margin-bottom: 1.2em; display: flex; gap: 0.7em; align-items: center;">
        <input type="text" name="query" placeholder="Search products..." style="padding: 0.5em; border-radius: 6px; border: 1px solid #ccc; width: 240px;">
        <button type="submit" class="forecast-btn">Search</button>
      </form>
      <h3>All Products</h3>
      <div id="product-tabs" style="margin-bottom:1em;">
        <button id="prev-tab" onclick="showPrevTab()" class="tab-btn">&#8592; Prev</button>
        <button id="next-tab" onclick="showNextTab()" class="tab-btn">Next &#8594;</button>
        <div id="product-groups">
          {% if all_products_with_prices and all_products_with_prices|length > 0 %}
            {% set num_groups = (all_products_with_prices|length // 6) + (1 if all_products_with_prices|length % 6 > 0 else 0) %}
            {% for group_idx in range(num_groups) %}
              <div class="product-group-grid{% if group_idx != 0 %} hidden-group{% endif %}">
                {% for product in all_products_with_prices[group_idx*6:(group_idx+1)*6] %}
                  <div class="product-card">
                    <div class="product-header">
                      <a href="{{ url_for('main.product_details', product_code=product.code) }}" style="text-decoration:none; color:inherit;">
                        <span class="product-title">{{ product.description }}</span>
                        <span class="product-code">Code: {{ product.code }}</span>
                      </a>
                    </div>
                    <div class="product-details">
                      {% if product.prices and product.prices|length > 0 %}
                        <span class="product-price">Last price: ${{ product.prices[-1] | round(2) }}</span>
                      {% endif %}
                    </div>
                    <div class="product-actions">
                      <a href="{{ url_for('predict.forecast_product', product_code=product.code) }}" class="forecast-btn">See forecast</a>
                      <form action="{{ url_for('watchlist.add_to_watchlist', product_id=product.ProductID) }}" method="post" style="display:inline;">
                        <button type="submit" class="watchlist-btn">Add to Watchlist</button>
                      </form>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% endfor %}
          {% else %}
            <div style="padding:1em;">No products found.</div>
          {% endif %}
        </div>
      </div>
    </div>
      <div class="related-watchlist-section">
        <div class="results">
          <h3>Related Products</h3>
          <ul>
            {% if product_name and related_products is defined and related_products|length > 0 %}
              {% for prod in related_products[:3] %}
                <li>{{ prod['description'] }} - ${{ prod['prices'][-1]|round(2) }}
                  <a href="{{ url_for('predict.forecast_product', product_code=prod['code']) }}"><span>see forecast</span></a>
                </li>
              {% endfor %}
            {% else %}
              <li>No related products found.</li>
            {% endif %}
          </ul>
        </div>

        <div class="watchlist-section">
          <h3>Your Watchlist</h3>
          {% if watchlist and watchlist|length > 0 %}
            <ul>
            {% for product in watchlist %}
              <li>
                <strong>{{ product.description }}</strong> (Code: {{ product.code }})
                <form action="{{ url_for('watchlist.remove_from_watchlist', product_id=product.ProductID) }}" method="post" style="display:inline;">
                  <button type="submit">Remove</button>
                </form>
                <a href="{{ url_for('predict.forecast_product', product_code=product.code) }}">See forecast</a>
              </li>
            {% endfor %}
            </ul>
          {% else %}
            <p>Your watchlist is empty.</p>
          {% endif %}
          <a href="{{ url_for('watchlist.view_watchlist') }}">View full watchlist</a>
        </div>
      </div>
    <button class="open-sidebar-btn" onclick="toggleSidebar()">‚ò∞</button>
    <!-- Move this block to the top, right after <h1>GenEcomm -->
    <script>
    function toggleSidebar() {
      var sidebar = document.getElementById('sidebar');
      sidebar.classList.toggle('sidebar-hidden');
      document.getElementById('openSidebarBtn').style.display = sidebar.classList.contains('sidebar-hidden') ? 'block' : 'none';
    }
    window.onload = function() {
      document.getElementById('openSidebarBtn').style.display = 'none';
    }

    // Product tab navigation
    let currentTab = 0;
    function showTab(idx) {
      const groups = document.querySelectorAll('.product-group-grid');
      if (groups.length === 0) return;
      groups.forEach((el, i) => {
        if (i === idx) {
          el.classList.remove('hidden-group');
        } else {
          el.classList.add('hidden-group');
        }
      });
    }
    function showPrevTab() {
      const groups = document.querySelectorAll('.product-group-grid');
      if (groups.length === 0) return;
      currentTab = (currentTab - 1 + groups.length) % groups.length;
      showTab(currentTab);
    }
    function showNextTab() {
      const groups = document.querySelectorAll('.product-group-grid');
      if (groups.length === 0) return;
      currentTab = (currentTab + 1) % groups.length;
      showTab(currentTab);
    }
    </script>
    </div>

  </div>
</div>
<script>
function toggleSidebar() {
  var sidebar = document.getElementById('sidebar');
  sidebar.classList.toggle('sidebar-hidden');
  // Show open button only when sidebar is hidden
  document.getElementById('openSidebarBtn').style.display = sidebar.classList.contains('sidebar-hidden') ? 'block' : 'none';
}
window.onload = function() {
  // Hide open button initially
  document.getElementById('openSidebarBtn').style.display = 'none';
}
</script>
{% endblock %}
